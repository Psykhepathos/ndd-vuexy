# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Quick Start

**Laravel + Vue.js unified transport management system using Vuexy template, connected to Progress OpenEdge via ODBC.**

```bash
# Start development servers
php artisan serve --port=8002  # Laravel API (Backend)
pnpm run dev                   # Vue frontend (Vite)

# Testing & validation
pnpm run typecheck            # TypeScript validation
pnpm run lint                 # ESLint with auto-fix
php artisan test              # Backend tests
composer test                 # Clear cache + run tests

# Build for production
pnpm run build                # Frontend production build
```

**IMPORTANTE - URLs de Acesso:**
- **Sistema completo (Frontend + API):** http://localhost:8002
- **Vite Dev Server (desenvolvimento apenas):** http://localhost:5173/5174/5176 (N√ÉO usar para visualiza√ß√£o)
- **Login:** admin@ndd.com / 123456

**‚ö†Ô∏è ATEN√á√ÉO:** SEMPRE use http://localhost:8002 para acessar o sistema! O Vite (porta 517x) √© apenas para desenvolvimento/hot-reload.

## üÜï Atualiza√ß√µes Recentes

### ‚úÖ FASE 1A: SemParar SOAP Core - COMPLETA (2025-10-27)

**Status:** Integra√ß√£o SOAP base com SemParar API est√° funcional

**Implementado:**
- ‚úÖ Cliente SOAP com TLS 1.2/1.3 (`app/Services/SemParar/SemPararSoapClient.php`)
- ‚úÖ Autentica√ß√£o com cache de token de 1 hora
- ‚úÖ Verifica√ß√£o de status de ve√≠culo
- ‚úÖ Endpoints REST de teste (`/api/semparar/*`)
- ‚úÖ Rate limiting configurado

**Teste r√°pido:**
```bash
curl http://localhost:8002/api/semparar/test-connection
# Deve retornar: {"success": true, "token_length": 19, ...}
```

**‚ö†Ô∏è Descoberta importante:**
```php
// ‚ùå ERRADO - Causa "Array to string conversion"
$client->__soapCall('autenticarUsuario', [['cnpj' => $x, 'login' => $y, 'senha' => $z]]);

// ‚úÖ CORRETO - Par√¢metros posicionais
$client->autenticarUsuario($cnpj, $user, $password);
// Retorna: stdClass { sessao: "3642419762017373443", status: 0 }
```

**Documenta√ß√£o completa:** `CHECKPOINT_FASE_1A.md`

---

### ‚úÖ FASE 1B: SemParar SOAP Routing - COMPLETA (2025-10-27)

**Status:** Roteiriza√ß√£o de pra√ßas de ped√°gio funcional

**Implementado:**
- ‚úÖ XML Builder para datasets Progress (`app/Services/SemParar/XmlBuilders/PontosParadaBuilder.php`)
- ‚úÖ `roteirizarPracasPedagio()` - Calcula pra√ßas de ped√°gio em rota
- ‚úÖ `cadastrarRotaTemporaria()` - Cadastra rota tempor√°ria
- ‚úÖ `obterCustoRota()` - Calcula custo total
- ‚úÖ Endpoints REST + interface de teste

**Bug Cr√≠tico Resolvido:**
```php
// ‚ùå ERRADO - PHP SoapClient envia XML vazio
$client->roteirizarPracasPedagio($pontosXml, $opcoesXml, $token);

// ‚úÖ CORRETO - Usar SoapVar com XSD_ANYXML
$pontosParam = new \SoapVar($pontosXml, XSD_ANYXML);
$opcoesParam = new \SoapVar($opcoesXml, XSD_ANYXML);
$client->roteirizarPracasPedagio($pontosParam, $opcoesParam, $token);
```

**Testes bem-sucedidos:**
- Rota SP‚ÜíRJ: **6 pra√ßas** encontradas
- Rota 183 + Pacote 3043368 (19 pontos): **12 pra√ßas** encontradas

**Documenta√ß√£o:** `SEMPARAR_FASE1B_COMPLETO.md`

---

### ‚úÖ FASE 2A: SemParar Trip Purchase - COMPLETA (2025-10-27)

**Status:** Compra de viagens SemParar funcional

**Implementado:**
- ‚úÖ `comprarViagem()` no SemPararService (105 linhas)
- ‚úÖ Endpoint REST `POST /api/semparar/comprar-viagem`
- ‚úÖ Valida√ß√£o de dados de compra
- ‚úÖ Interface de teste com confirma√ß√£o

**Fluxo completo:**
1. Roteirizar pra√ßas ‚Üí 2. Cadastrar rota tempor√°ria ‚Üí 3. Obter custo ‚Üí 4. **Comprar viagem**

**Endpoint:**
```bash
POST /api/semparar/comprar-viagem
{
  "nome_rota": "TESTE_SP_RJ",
  "placa": "ABC1234",
  "eixos": 2,
  "data_inicio": "2025-10-27",
  "data_fim": "2025-10-27",
  "item_fin1": "PEDAGIO"
}

# Response:
{
  "success": true,
  "data": {
    "cod_viagem": "123456789",
    "status": 0
  }
}
```

**‚ö†Ô∏è ATEN√á√ÉO:** Esta opera√ß√£o EFETIVA a compra no SemParar! Use com cuidado.

**P√°gina de teste:** http://localhost:8002/test-semparar-fase1b.html

**Pr√≥xima fase:** FASE 2B - Integra√ß√£o com Progress (salvar viagens no banco)

---

### üó∫Ô∏è MIGRA√á√ÉO: Google Maps ‚Üí Leaflet + OpenStreetMap + OSRM (100% GRATUITO!)

**Data:** 2025-10-21 (Atualizado: 2025-10-27)
**Impacto:** Sistema de mapas agora √© 100% gratuito, sem depend√™ncia de API keys do Google Maps

**O que mudou:**
- ‚ùå **REMOVIDO:** Google Maps API (tiles + routing)
- ‚úÖ **ADICIONADO:** Leaflet.js + OpenStreetMap (tiles gratuitos)
- ‚úÖ **ADICIONADO:** OSRM OpenStreetMap.de (routing gratuito, sem API key)
- ‚úÖ **MANTIDO:** Google Geocoding API (apenas para IBGE ‚Üí coordenadas, com cache agressivo)

**Tecnologias:**
```typescript
// Frontend
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'
import 'leaflet-routing-machine'
import 'leaflet-routing-machine/dist/leaflet-routing-machine.css'

// Mapa
L.map(container).setView([-14.2350, -51.9253], 4)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

// Routing GRATUITO
const osrmRouter = L.Routing.osrmv1({
  serviceUrl: 'https://routing.openstreetmap.de/routed-car/route/v1',
  profile: 'driving',
  timeout: 30000
})
```

**Arquivos modificados:**
- `resources/ts/pages/rotas-semparar/mapa/[id].vue` - Migrado para Leaflet
- `resources/ts/pages/test-leaflet-pacote.vue` - Teste funcional com pacote real

**Features mantidas:**
- ‚úÖ Marcadores numerados customizados
- ‚úÖ Popups com informa√ß√µes
- ‚úÖ Rotas seguindo estradas reais (n√£o linhas retas)
- ‚úÖ Geocoding autom√°tico
- ‚úÖ Sistema de debug visual
- ‚úÖ Simula√ß√£o de pacotes
- ‚úÖ Drag & drop de munic√≠pios
- ‚úÖ Fallback para linha reta em caso de erro

**Limita√ß√µes conhecidas:**
- ‚ö†Ô∏è OSRM p√∫blico pode ter downtime ocasional (fallback implementado)
- ‚ö†Ô∏è Limite de ~25-50 waypoints por rota (limite do OSRM p√∫blico)
- ‚úÖ Solu√ß√£o futura: Hospedar OSRM pr√≥prio via Docker

**Benef√≠cios:**
- üí∞ **Custo ZERO** - Sem mais custos de Google Maps API
- üöÄ **Performance** - OpenStreetMap √© r√°pido e confi√°vel
- üîì **Open Source** - Stack 100% open source

**URLs de Teste:**
- Rota SemParar: http://localhost:8002/rotas-semparar/mapa/204
- Teste Pacote: http://localhost:8002/test-leaflet-pacote

**Documenta√ß√£o:**
- An√°lise completa: `ANALISE_ROTAS_SEMPARAR.md`
- Debug system: `DEBUG_MAPA_ROTAS.md`

---

### 1. Sistema de Debug para Mapa de Rotas SemParar
Implementado sistema completo de debug e diagn√≥stico para resolver problemas de geocoding e renderiza√ß√£o de mapas.

**Arquivo principal**: `resources/ts/pages/rotas-semparar/mapa/[id].vue`
**Documenta√ß√£o completa**: `DEBUG_MAPA_ROTAS.md`

**Recursos implementados**:
- üêõ **Painel de Debug Visual**: Acess√≠vel via bot√£o "Debug" no header
- üìä **M√©tricas em Tempo Real**: Geocodes, cache hits, atualiza√ß√µes do mapa
- üìã **Logging Estruturado**: 4 n√≠veis (info/warn/error/success) e 6 categorias
- ‚úÖ **Valida√ß√£o de Coordenadas**: `isValidCoordinate()` e `sanitizeCoordinate()`
- üîÑ **Controle de Sincroniza√ß√£o**: Debounce (300ms), lock anti-concorr√™ncia, queue de geocoding
- üó∫Ô∏è **Indicadores Visuais**: Marcadores coloridos por status, InfoWindow detalhado

**Problemas solucionados**:
- ‚úÖ Race conditions no geocoding (processamento agora √© sequencial)
- ‚úÖ Valida√ß√£o inadequada de coordenadas (valida√ß√£o rigorosa implementada)
- ‚úÖ M√∫ltiplas atualiza√ß√µes do mapa (debouncing de 300ms)
- ‚úÖ Watch inadequado (removido, substitu√≠do por chamadas expl√≠citas)
- ‚úÖ Falta de observabilidade (sistema completo de logs e m√©tricas)

**Como usar o Debug**:
1. Acesse http://localhost:8002/rotas-semparar/mapa/{id}
2. Clique no bot√£o "Debug" no header
3. Veja estat√≠sticas, estado dos munic√≠pios e logs do sistema
4. Use para diagnosticar problemas de geocoding ou renderiza√ß√£o

### 2. Suporte a UPDATE/INSERT/DELETE no Progress Database
Progress JDBC **N√ÉO suporta transa√ß√µes**. Sistema atualizado para executar comandos de modifica√ß√£o sem transa√ß√µes.

**Java Connector** (`storage/app/java/ProgressJDBCConnector.java`):
- Nova a√ß√£o `update` para UPDATE/INSERT/DELETE
- Valida√ß√£o de seguran√ßa (apenas comandos permitidos)
- Retorna n√∫mero de linhas afetadas

**ProgressService** (`app/Services/ProgressService.php`):
- **Novo m√©todo**: `executeUpdate($sql)` - Executa UPDATE/INSERT/DELETE
- **M√©todo existente**: `executeCustomQuery($sql)` - Apenas SELECT (seguran√ßa)
- **M√©todos atualizados**: `updateSemPararRota()`, `deleteSemPararRota()` agora usam `executeUpdate()`
- **REMOVIDO**: Suporte a transa√ß√µes (beginTransaction/commit/rollBack n√£o funcionam com ODBC)

**Outros Services:**
- **GeocodingService**: Converte c√≥digos IBGE ‚Üí lat/lon usando Google Geocoding API
- **RoutingService**: Calcula rotas entre coordenadas usando Google Directions API

**‚ö†Ô∏è IMPORTANTE**:
```php
// ‚ùå ERRADO - Progress JDBC n√£o suporta transa√ß√µes
DB::connection('progress')->beginTransaction();
$this->executeUpdate($sql);
DB::connection('progress')->commit();

// ‚úÖ CORRETO - Executar queries individuais
$this->executeUpdate($sql1);
$this->executeUpdate($sql2);
$this->executeUpdate($sql3);
```

**SQL deve ser em linha √∫nica** (Progress n√£o gosta de quebras de linha):
```php
// ‚ùå ERRADO - Multi-linha
$sql = "UPDATE PUB.semPararRot SET
  desSPararRot = 'Teste',
  tempoViagem = 5
  WHERE sPararRotID = 204";

// ‚úÖ CORRETO - Single-line
$sql = "UPDATE PUB.semPararRot SET desSPararRot = 'Teste', tempoViagem = 5 WHERE sPararRotID = 204";
```

### 3. Sistema de Geocoding e Routing com Cache

**Geocoding** (converte IBGE ‚Üí lat/lon):
- **API**: `POST /api/geocoding/ibge` e `POST /api/geocoding/lote`
- **Service**: `GeocodingService.php` - Google Geocoding API + cache local
- **Model**: `MunicipioCoordenada.php` - Cache de coordenadas por c√≥digo IBGE
- **Cache**: Tabela `municipio_coordenadas` (persistente, sem expira√ß√£o)

**Routing** (calcula rotas com estradas reais):
- **API**: `POST /api/routing/calculate`
- **Service**: `RoutingService.php` - Google Directions API + cache de segmentos
- **Model**: `RouteSegment.php` - Cache de segmentos origem‚Üídestino
- **Cache**: Tabela `route_segments` (30 dias, toler√¢ncia ~100m)
- **Rate Limiting**: 200ms entre novas requisi√ß√µes ao Google

**Benef√≠cios**:
- Cache reduz 80%+ de chamadas √† API do Google ap√≥s primeira visualiza√ß√£o
- Rotas s√£o desenhadas com estradas reais, n√£o linhas retas
- Segmentos s√£o reutilizados entre diferentes rotas

## Architecture Overview

```
Vue/Vuexy ‚Üê REST API ‚Üí Laravel ‚Üê ODBC ‚Üí Progress Database
```

- **Frontend**: Vue 3.5.14 + TypeScript + Vuexy template + Vuetify 3.8.5
- **Backend**: Laravel 12.15.0 + Laravel Sanctum authentication
- **Database**: Progress OpenEdge via ODBC (direct connection, no Kafka)
- **Build**: Vite 6.3.5 + PNPM package manager

## Critical Development Rules

### 1. Vuexy Template Usage (MANDATORY)
**NEVER create UI from scratch. ALWAYS copy from existing Vuexy templates:**
- Lists: `resources/ts/pages/apps/user/list/index.vue`
- Forms: `resources/ts/pages/apps/user/view/UserBioPanel.vue`
- Dashboards: `resources/ts/pages/apps/logistics/dashboard.vue`

**Use Vuexy components:**
- `AppTextField` instead of `VTextField`
- `AppSelect` instead of `VSelect`
- `VDataTableServer` for paginated tables
- Theme classes: `text-high-emphasis`, `text-medium-emphasis`

### 2. Progress Database Access
**ALWAYS use JDBC direct connection, NOT Eloquent for Progress tables:**
```php
// ‚úÖ CORRECT - Direct JDBC for Progress tables
DB::connection('progress')->select('SELECT * FROM PUB.pacote WHERE codpac = ?', [$id]);
$this->progressService->executeCustomQuery($sql);

// ‚ùå WRONG - Never use Eloquent for Progress tables
Pacote::find(123);  // Won't work with JDBC!

// ‚úÖ CORRECT - Eloquent CAN be used for Laravel internal tables (SQLite, MySQL)
$coords = MunicipioCoordenada::where('cdibge', $codigoIBGE)->first();  // Cache table (SQLite)
$user = User::find($userId);  // Laravel users table
$segment = RouteSegment::where('origin_lat', $lat)->first();  // Cache table (SQLite)
```

**Summary:**
- **Progress tables (PUB.*)** ‚Üí Raw JDBC via ProgressService ‚úÖ
- **Laravel tables (users, cache, etc)** ‚Üí Eloquent ORM ‚úÖ

### 3. Git Commits
- **NEVER** mention Claude, AI, or use emojis in commits
- Use technical, descriptive messages
- Configure: `git config --global user.name "Psykhepathos"`

## Key Services & APIs

### ProgressService Methods
**Core Connection:**
- `testConnection()` - Test JDBC connection
- `executeCustomQuery($sql)` - Run custom SQL (SELECT only, for security)
- `executeUpdate($sql)` - Run UPDATE/INSERT/DELETE (NEW in 2025-09-30)
- `executeJavaConnector($action, ...$params)` - Execute JDBC Java connector

**Transportes:**
- `getTransportesPaginated($filters)` - Get transporters with pagination
- `getTransporteById($id)` - Get specific transporter
- `getMotoristasPorTransportador($id)` - Get drivers by transporter
- `getVeiculosPorTransportador($id)` - Get vehicles by transporter

**Pacotes:**
- `getPacotesPaginated($filters)` - Get packages with pagination
- `getPacoteById($id)` - Get specific package
- `getItinerarioPacote($codPac)` - Get full package itinerary with deliveries

**Rotas & Autocomplete:**
- `getRotas($search)` - Autocomplete for routes
- `getMunicipiosForAutocomplete($search, $estadoId)` - City search
- `getEstadosForAutocomplete()` - State list

**SemParar Routes:**
- `getSemPararRotas($filters)` - List SemParar routes with pagination
- `getSemPararRota($id)` - Get specific route with municipalities
- `createSemPararRota($data)` - Create new route
- `updateSemPararRota($id, $data)` - Update route
- `deleteSemPararRota($id)` - Delete route
- `updateSemPararRotaMunicipios($id, $municipios)` - Update municipalities

### API Endpoints
**Progress Database:**
- `GET /api/progress/test-connection` - Test database connection
- `POST /api/progress/query` - Execute custom SQL queries
- `GET /api/progress/transportes` - List transporters
- `GET /api/progress/transportes/{id}` - Get specific transporter

**Transportes:**
- `GET /api/transportes` - List transporters (paginated)
- `GET /api/transportes/{id}` - Get transporter details
- `GET /api/transportes/statistics` - Get statistics
- `GET /api/transportes/schema` - Get table schema

**Pacotes:**
- `GET /api/pacotes` - List packages (paginated with filters)
- `GET /api/pacotes/{id}` - Get package details
- `POST /api/pacotes/itinerario` - Get package itinerary with deliveries
- `GET /api/pacotes/statistics` - Get statistics

**Rotas:**
- `GET /api/rotas?search={term}` - Autocomplete for routes

**SemParar Rotas:**
- `GET /api/semparar-rotas` - List routes (paginated with filters)
- `GET /api/semparar-rotas/{id}` - Get specific route
- `GET /api/semparar-rotas/{id}/municipios` - Get route with municipalities
- `POST /api/semparar-rotas` - Create new route
- `PUT /api/semparar-rotas/{id}` - Update route
- `PUT /api/semparar-rotas/{id}/municipios` - Update municipalities
- `DELETE /api/semparar-rotas/{id}` - Delete route
- `GET /api/semparar-rotas/municipios?search={term}` - City autocomplete
- `GET /api/semparar-rotas/estados` - List states

**Geocoding:**
- `POST /api/geocoding/ibge` - Get coordinates from single IBGE code
- `POST /api/geocoding/lote` - Get coordinates from multiple IBGE codes (batch)

**Routing & Maps:**
- `GET /api/routing/test` - Test routing service
- `POST /api/routing/route` - Calculate route
- `POST /api/routing/calculate` - Calculate route with waypoints
- `POST /api/route-cache/find` - Find cached route
- `POST /api/route-cache/save` - Save route to cache
- `GET /api/route-cache/stats` - Cache statistics
- `DELETE /api/route-cache/clear-expired` - Clear expired cache entries

**Google Maps Quota:**
- `GET /api/google-maps/quota` - Get current API usage statistics
- `POST /api/google-maps/reset-counters` - Reset usage counters (admin)

### Progress SQL Conventions
- **Schema:** Always use `PUB.tablename` (e.g., `PUB.transporte`, `PUB.pacote`)
- **Limit:** Use `SELECT TOP 10` (not LIMIT)
- **Offset:** Progress lacks native OFFSET - simulate with subqueries or fetch all + array_slice in PHP
- **Case:** Progress is case-sensitive for table/column names
- **Strings:** Use single quotes `'value'`
- **Joins:** Use `LEFT JOIN` syntax, not nested subqueries
- **Transactions:** ‚ö†Ô∏è **NUNCA USE TRANSA√á√ïES** - Progress JDBC n√£o suporta `beginTransaction()/commit()/rollBack()`
- **SQL Format:** Use single-line queries (Progress JDBC tem problemas com quebras de linha)

**Common Tables:**
- `PUB.transporte` - Transporters (codtrn, nomtrn, flgautonomo, codcnpjcpf)
- `PUB.pacote` - Packages (codpac, codtrn, codmot, sitpac, datforpac)
- `PUB.carga` - Loads (codcar, codpac)
- `PUB.pedido` - Orders/Deliveries (numseqped, codcar, codcli)
- `PUB.introt` - Routes (codrot, desrot)
- `PUB.semPararRot` - SemParar Routes (sPararRotID, desSPararRot, flgCD)
- `PUB.semPararRotMu` - SemParar Municipalities (sPararRotID, codMun, codEst)
- `PUB.municipio` - Cities (codmun, desmun, cdibge)
- `PUB.estado` - States (codest, nomest, siglaest)

## API Rate Limiting & Security

**Rate limits configured in `routes/api.php`:**
- **Test endpoints**: 10 req/min (`/api/transportes/test-connection`)
- **Statistics/Schema**: 10 req/min (expensive queries)
- **CRUD operations**: 60 req/min (standard operations)
- **Custom queries**: 5 req/min (admin-only, requires authentication)

**Authentication:**
- **Public endpoints** (no auth required):
  - All Progress test connections
  - Transporter/package listings
  - Geocoding and routing services
  - SemParar routes (read-only)

- **Protected endpoints** (require `auth:sanctum`):
  - `POST /api/transportes/query` - Custom SQL queries (admin-only)
  - `POST /api/auth/logout`
  - `GET /api/auth/user`

**Auth flow:**
1. `POST /api/auth/login` ‚Üí Returns Sanctum token
2. Include token in header: `Authorization: Bearer {token}`
3. `POST /api/auth/logout` when done

## Project Structure

```
ndd-vuexy/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Http/Controllers/Api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.php              # Authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TransporteController.php        # Transporters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PacoteController.php            # Packages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MotoristaController.php         # Drivers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RotaController.php              # Routes autocomplete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SemPararRotaController.php      # SemParar routes CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GeocodingController.php         # IBGE ‚Üí lat/lon conversion
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoutingController.php           # Route calculation proxy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RouteCacheController.php        # Route cache management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GoogleMapsQuotaController.php   # API quota monitoring
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProgressController.php          # Raw Progress queries
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îú‚îÄ‚îÄ ProgressService.php             # Main Progress DB service (1500+ lines)
‚îÇ       ‚îú‚îÄ‚îÄ GeocodingService.php            # Google Geocoding API integration
‚îÇ       ‚îî‚îÄ‚îÄ RoutingService.php              # Google Directions API integration
‚îú‚îÄ‚îÄ resources/ts/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transportes/                    # Transporters module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pacotes/                        # Packages module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vale-pedagio/                   # Toll pass calculator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rotas-semparar/                 # SemParar routes with map
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ apps/                           # Vuexy example pages (reference templates)
‚îÇ   ‚îú‚îÄ‚îÄ @layouts/                           # Layout components
‚îÇ   ‚îú‚îÄ‚îÄ navigation/vertical/ndd.ts          # Left sidebar menu
‚îÇ   ‚îî‚îÄ‚îÄ plugins/                            # Vue plugins (router, vuetify, etc)
‚îú‚îÄ‚îÄ routes/api.php                          # API routes
‚îú‚îÄ‚îÄ storage/app/java/
‚îÇ   ‚îú‚îÄ‚îÄ ProgressJDBCConnector.java          # JDBC connector for Progress
‚îÇ   ‚îî‚îÄ‚îÄ gson-2.8.9.jar                      # JSON library for Java
‚îî‚îÄ‚îÄ database/migrations/                    # SQLite migrations (NOT Progress)

## Development Workflow

### Creating New Features
1. Check Progress table structure via `/api/progress/query`
2. Add method to `ProgressService.php`
3. Create controller in `app/Http/Controllers/Api/`
4. Register route in `routes/api.php`
5. Copy similar Vuexy template for frontend
6. Test with curl before frontend integration

### Testing Checklist
- [ ] ODBC connection: `curl http://localhost:8002/api/progress/test-connection`
- [ ] TypeScript: `pnpm run typecheck`
- [ ] Linting: `pnpm run lint`
- [ ] Backend tests: `php artisan test`
- [ ] Manual testing in browser

## Common Issues & Solutions

### Port conflicts
```bash
netstat -ano | findstr :8002  # Check port usage
taskkill /PID [PID] /F        # Kill process
```

### Vue compilation errors
```bash
rm -rf node_modules/.vite     # Clear Vite cache
pnpm run dev                  # Restart
```

### Progress connection issues
```bash
# Test via API
curl "http://localhost:8002/api/progress/test-connection"
```

## Environment Configuration

```env
# Progress Database
PROGRESS_HOST=192.168.80.113
PROGRESS_DATABASE=tambasa
PROGRESS_USERNAME=sysprogress
PROGRESS_PASSWORD=sysprogress

# Google Maps API (for geocoding and routing)
GOOGLE_MAPS_API_KEY=your_api_key_here

# API URLs
LARAVEL_API=http://localhost:8002
VUE_FRONTEND=http://localhost:5174
```

## üõí Sistema de Compra de Viagem SemParar - API Backend (FASE 1A + 1B + 2A + 2B + 2C ‚úÖ)

**Status:** Backend completo e funcional (roteiriza√ß√£o, compra, persist√™ncia, recibo). Frontend em desenvolvimento.

**Vis√£o Geral:**
Sistema de compra de viagens integrado com API SOAP SemParar para gest√£o de ped√°gios e rotas de transporte. O backend est√° 100% funcional e testado.

### FASE 1A - SOAP Core (‚úÖ COMPLETA)
**Implementa√ß√£o:** `app/Services/SemParar/SemPararService.php`, `app/Services/SemParar/SoapClient.php`

**Funcionalidades:**
- ‚úÖ Autentica√ß√£o SOAP (`autenticarUsuario()`)
- ‚úÖ Cache de token (dura√ß√£o da sess√£o)
- ‚úÖ Status de ve√≠culo (`statusVeiculo()`)
- ‚úÖ Gest√£o de sess√£o SOAP

**Endpoints:**
- `GET /api/semparar/test-connection` - Test SOAP connection
- `POST /api/semparar/status-veiculo` - Verify vehicle status
- `GET /api/semparar/debug/token` - Get cached token (debug only)
- `POST /api/semparar/debug/clear-cache` - Clear token cache

### FASE 1B - Roteiriza√ß√£o (‚úÖ COMPLETA)
**Funcionalidades:**
- ‚úÖ Roteirizar pra√ßas de ped√°gio entre munic√≠pios (`roteirizarPracasPedagio()`)
- ‚úÖ Cadastrar rota tempor√°ria (`cadastrarRotaTemporaria()`)
- ‚úÖ Obter custo da rota (`obterCustoRota()`)
- ‚úÖ Suporte a SoapVar para par√¢metros XML

**Endpoints:**
- `POST /api/semparar/roteirizar` - Route toll plazas between municipalities
- `POST /api/semparar/rota-temporaria` - Create temporary route
- `POST /api/semparar/custo-rota` - Get route cost

**Exemplo de uso:**
```bash
# 1. Roteirizar munic√≠pios
curl -X POST http://localhost:8002/api/semparar/roteirizar \
  -H "Content-Type: application/json" \
  -d '{"pontos": [{"cod_ibge": 3118601, "desc": "CONTAGEM", "latitude": -19.9384589, "longitude": -44.0518344}], "alternativas": false}'

# 2. Cadastrar rota tempor√°ria
curl -X POST http://localhost:8002/api/semparar/rota-temporaria \
  -H "Content-Type: application/json" \
  -d '{"praca_ids": [1030, 1028, 1026], "nome_rota": "ROTA_TEMP_123456"}'

# 3. Obter custo
curl -X POST http://localhost:8002/api/semparar/custo-rota \
  -H "Content-Type: application/json" \
  -d '{"nome_rota": "ROTA_TEMP_123456", "placa": "ABC1234", "eixos": 2, "data_inicio": "2025-10-27", "data_fim": "2025-11-03"}'
```

### FASE 2A - Compra de Viagem (‚úÖ COMPLETA)
**Implementa√ß√£o:** `app/Services/SemParar/SemPararService.php` - `comprarViagem()` (105 lines)

**Funcionalidades:**
- ‚úÖ Comprar viagem via SOAP (`comprarViagem()`)
- ‚úÖ Extra√ß√£o do c√≥digo da viagem do XML response
- ‚úÖ Tratamento de erros SOAP
- ‚úÖ Rate limiting (10 req/min)

**Endpoint:**
- `POST /api/semparar/comprar-viagem` - Purchase trip

**Par√¢metros obrigat√≥rios:**
- `nome_rota` (string) - Nome da rota tempor√°ria criada
- `placa` (string) - Placa do ve√≠culo (7-8 chars)
- `eixos` (int) - N√∫mero de eixos (2-9)
- `data_inicio` (date) - Data in√≠cio formato YYYY-MM-DD
- `data_fim` (date) - Data fim (>= data_inicio)
- `item_fin1` (string, opcional) - Item financeiro 1 (default: "")

**Retorno:**
```json
{
  "success": true,
  "message": "Viagem comprada com sucesso",
  "data": {
    "success": true,
    "cod_viagem": "68470838",
    "status": "0"
  }
}
```

### FASE 2B - Persist√™ncia no Progress Database (‚úÖ COMPLETA)
**Implementa√ß√£o:**
- `app/Services/ProgressService.php` - `salvarViagemSemParar()` (109 lines)
- `app/Http/Controllers/Api/SemPararController.php` - Integration (lines 325-344)

**Funcionalidades:**
- ‚úÖ Salvar viagem no Progress ap√≥s compra bem-sucedida
- ‚úÖ Valida√ß√£o de campos obrigat√≥rios
- ‚úÖ SQL escaping para prevenir injection
- ‚úÖ Persist√™ncia opcional (s√≥ salva se `cod_pac` fornecido)
- ‚úÖ Non-blocking (compra funciona mesmo se Progress falhar)

**Tabela Progress:**
```sql
PUB.sPararViagem
‚îú‚îÄ‚îÄ codviagem (string) - C√≥digo da viagem no SemParar
‚îú‚îÄ‚îÄ codpac (int) - C√≥digo do pacote
‚îú‚îÄ‚îÄ numpla (string) - Placa do ve√≠culo
‚îú‚îÄ‚îÄ nomrotsemparar (string) - Nome da rota
‚îú‚îÄ‚îÄ valviagem (decimal) - Valor da viagem
‚îú‚îÄ‚îÄ codtrn (int) - C√≥digo do transportador
‚îú‚îÄ‚îÄ codrotcreatesp (string) - C√≥digo da rota criada
‚îú‚îÄ‚îÄ spararrotid (int) - ID da rota SemParar
‚îú‚îÄ‚îÄ rescompra (string) - Respons√°vel pela compra
‚îú‚îÄ‚îÄ datacompra (date) - Data da compra
‚îú‚îÄ‚îÄ flgcancelado (bool) - Flag de cancelamento
‚îî‚îÄ‚îÄ rescancel (string) - Respons√°vel pelo cancelamento
```

**Endpoint (integrado):**
- `POST /api/semparar/comprar-viagem` - Purchase trip + save to Progress

**Par√¢metros opcionais (FASE 2B):**
- `cod_pac` (int) - Package ID (triggers Progress save)
- `cod_trn` (int) - Transporter ID
- `s_parar_rot_id` (int) - SemParar route ID
- `cod_rota_create_sp` (string) - Route creation code
- `valor_viagem` (decimal) - Trip cost
- `res_compra` (string) - Purchase responsible

**Retorno com Progress:**
```json
{
  "success": true,
  "message": "Viagem comprada com sucesso",
  "data": {
    "success": true,
    "cod_viagem": "68470838",
    "status": "0",
    "progress_saved": true
  }
}
```

**Exemplo completo (FASE 2A + 2B):**
```bash
curl -X POST http://localhost:8002/api/semparar/comprar-viagem \
  -H "Content-Type: application/json" \
  -d '{
    "nome_rota": "ROTA_TEMP_123456",
    "placa": "ABC1234",
    "eixos": 2,
    "data_inicio": "2025-10-27",
    "data_fim": "2025-11-03",
    "item_fin1": "PEDAGIO",
    "cod_pac": 3043368,
    "cod_trn": 5576,
    "s_parar_rot_id": 204,
    "cod_rota_create_sp": "ROTA_TEMP_123456",
    "valor_viagem": 123.45,
    "res_compra": "sistema"
  }'
```

### FASE 2C - Recibo PDF (‚úÖ COMPLETA + Envio WhatsApp)
**Implementa√ß√£o:**
- `app/Services/SemParar/SemPararService.php` - `obterRecibo()` (118 lines) + `gerarRecibo()` (130 lines)
- `app/Http/Controllers/Api/SemPararController.php` - `obterRecibo()` + `gerarRecibo()` endpoints

**Funcionalidades:**
- ‚úÖ Obter recibo em PDF da viagem comprada (base64)
- ‚úÖ Gerar recibo e enviar por WhatsApp/Email (via servi√ßo Node.js)
- ‚úÖ Download autom√°tico no browser
- ‚úÖ Valida√ß√£o de c√≥digo de viagem e telefone
- ‚úÖ Tratamento de erros (viagem n√£o encontrada, recibo indispon√≠vel, servi√ßo offline)

**Endpoints:**

#### 1. Obter Recibo PDF (download direto)
- `POST /api/semparar/obter-recibo` - Get trip receipt PDF in base64

**Par√¢metros:**
- `cod_viagem` (string, obrigat√≥rio) - Trip code from comprarViagem()

**Retorno com sucesso:**
```json
{
  "success": true,
  "message": "Recibo obtido com sucesso",
  "data": {
    "recibo_pdf": "JVBERi0xLjQKJe...",  // Base64 encoded PDF
    "pdf_size_bytes": 45678,
    "status": 0,
    "status_mensagem": "Sucesso"
  }
}
```

**Status codes SemParar:**
- `0` - Sucesso (PDF dispon√≠vel)
- `15` - Recibo n√£o dispon√≠vel (viagem antiga/usada/inv√°lida)
- `999` - Erro desconhecido

**Exemplo de uso:**
```bash
curl -X POST http://localhost:8002/api/semparar/obter-recibo \
  -H "Content-Type: application/json" \
  -d '{"cod_viagem": "68470838"}'
```

#### 2. Gerar e Enviar Recibo por WhatsApp/Email (recomendado)
- `POST /api/semparar/gerar-recibo` - Generate receipt and send via WhatsApp/Email

**Par√¢metros:**
- `cod_viagem` (string, obrigat√≥rio) - Trip code
- `telefone` (string, obrigat√≥rio) - Phone in format 5531988892076 (country+ddd+number)
- `email` (string, opcional) - Email address
- `flg_imprime` (boolean, opcional) - Print/display flag (default: true)

**Retorno com sucesso:**
```json
{
  "success": true,
  "message": "Recibo gerado e enviado com sucesso",
  "data": {
    "success": true,
    "message": "Recibo gerado e enviado com sucesso",
    "status": "success",
    "telefone": "5531988892076",
    "email": "user@example.com"
  }
}
```

**Fluxo interno (seguindo Progress):**
1. Chama SOAP `obterReciboViagem()` para pegar dados
2. Envia para Node.js service (`http://192.168.19.35:5001/gerar-vale-pedagio`)
3. Service gera PDF e envia por WhatsApp/Email

**Exemplo de uso:**
```bash
curl -X POST http://localhost:8002/api/semparar/gerar-recibo \
  -H "Content-Type: application/json" \
  -d '{
    "cod_viagem": "68470838",
    "telefone": "5531988892076",
    "email": "usuario@example.com",
    "flg_imprime": true
  }'
```

**Observa√ß√µes:**
- ‚ö†Ô∏è Requer servi√ßo Node.js rodando em 192.168.19.35:5001
- üì± WhatsApp recebe PDF automaticamente
- üìß Email opcional (se fornecido, tamb√©m envia por email)
- ‚è±Ô∏è Rate limit: 20 req/min (protege contra spam)

### üß™ Teste Completo (FASE 1A ‚Üí 1B ‚Üí 2A ‚Üí 2B ‚Üí 2C)
**Interface HTML:** `public/test-semparar-fase1b.html`

**Acesso:** http://localhost:8002/test-semparar-fase1b.html

**Workflow de teste:**
1. **Teste 1:** Roteirizar munic√≠pios (FASE 1B)
2. **Teste 2:** Cadastrar rota tempor√°ria (FASE 1B)
3. **Teste 3:** Obter custo da rota (FASE 1B)
4. **Teste 4:** Comprar viagem (FASE 2A + 2B)
5. **Teste 5:** Baixar recibo PDF (FASE 2C) ‚Üê NOVO!
6. **Verificar Progress:** Query `PUB.sPararViagem` (FASE 2B)

**Scripts de teste:**
- `test-fase2b-completo.ps1` - PowerShell test script (Windows)
- `test-roteirizar.json` - Simple route test data
- `test-roteirizar-completo.json` - Complete route test data (4 municipalities)

### üìã Pr√≥ximas Fases (Planejadas)
- **FASE 3A:** Valida√ß√£o e pesquisa de viagens
- **FASE 3B:** Frontend Vue.js integration (`resources/ts/pages/compra-viagem/`)

### üîó Documenta√ß√£o Adicional
- `SEMPARAR_IMPLEMENTATION_ROADMAP.md` - Complete implementation plan
- `COMPRA_VIAGEM_ANALISE.md` - Business analysis and requirements

---

## üó∫Ô∏è Sistema de Rotas SemParar (M√≥dulo Completo)

**Vis√£o Geral:**
Sistema de gest√£o de rotas pr√©-cadastradas no Progress Database com visualiza√ß√£o em mapa interativo (Leaflet + OpenStreetMap) e capacidade de simular entregas reais de pacotes sobre essas rotas.

### Arquitetura

```
Frontend (Vue)                Backend (Laravel)              Database (Progress)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ index.vue    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ SemPararRota     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ PUB.semPararRot  ‚îÇ
‚îÇ (Listagem)   ‚îÇ             ‚îÇ Controller       ‚îÇ          ‚îÇ (Rotas)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ                              ‚îÇ
‚îÇ mapa/[id].vue‚îÇ                      ‚ñº                              ‚ñº
‚îÇ (Visualizar/ ‚îÇ             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Editar)     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ProgressService  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ PUB.semPararRotMu‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ (JDBC Connector) ‚îÇ          ‚îÇ (Munic√≠pios)     ‚îÇ
       ‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ usePackage       ‚îÇ
‚îÇ Simulation       ‚îÇ
‚îÇ (Composable)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Leaflet +        ‚îÇ
‚îÇ OpenStreetMap +  ‚îÇ
‚îÇ OSRM Routing     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes Principais

#### 1. **index.vue** - Listagem de Rotas
**Path:** `resources/ts/pages/rotas-semparar/index.vue`

**Features:**
- ‚úÖ VDataTableServer com pagina√ß√£o server-side
- ‚úÖ Filtros tri-state (Tipo: All/CD/Rota, Retorno: All/Sim/N√£o)
- ‚úÖ Busca por nome com debounce (500ms)
- ‚úÖ Estat√≠sticas (total, CDs, rotas com retorno)
- ‚úÖ A√ß√µes: Visualizar, Editar, Deletar

**Endpoints usados:**
- `GET /api/semparar-rotas?page=1&per_page=10&flg_cd=true`

#### 2. **mapa/[id].vue** - Visualiza√ß√£o + Edi√ß√£o + Simula√ß√£o
**Path:** `resources/ts/pages/rotas-semparar/mapa/[id].vue`

**Features:**
- ‚úÖ Mapa interativo Leaflet + OpenStreetMap (100% gratuito)
- ‚úÖ Marcadores numerados customizados (L.divIcon)
- ‚úÖ Roteamento real via OSRM (routing.openstreetmap.de)
- ‚úÖ Geocoding autom√°tico (Google API + cache SQLite)
- ‚úÖ Drag & drop para reordenar munic√≠pios (vuedraggable)
- ‚úÖ Adicionar/remover munic√≠pios via autocomplete
- ‚úÖ Simula√ß√£o de pacotes sobre a rota
- ‚úÖ Debug panel com logs e m√©tricas

**Endpoints usados:**
- `GET /api/semparar-rotas/{id}/municipios`
- `PUT /api/semparar-rotas/{id}`
- `PUT /api/semparar-rotas/{id}/municipios`
- `POST /api/geocoding/lote`
- `POST /api/pacotes/itinerario`

**Tecnologias de Mapa:**
```typescript
// Inicializa√ß√£o
map = L.map(container).setView([-14.2350, -51.9253], 4)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

// Routing GRATUITO
const osrmRouter = L.Routing.osrmv1({
  serviceUrl: 'https://routing.openstreetmap.de/routed-car/route/v1',
  profile: 'driving'
})

// Marcadores customizados
const icon = L.divIcon({
  html: `<div style="background: #2196F3; ...">1</div>`
})
```

#### 3. **usePackageSimulation.ts** - Composable de Simula√ß√£o
**Path:** `resources/ts/composables/usePackageSimulation.ts`

**Responsabilidades:**
- Autocomplete de pacotes
- Carregar itiner√°rio de pacote
- Processar coordenadas GPS do Progress ("230876543" ‚Üí -23.0876543)
- Gerenciar estado da simula√ß√£o
- Criar marcadores e waypoints combinados (rota + entregas)

**Exemplo de uso:**
```typescript
const {
  selectedPacote,
  entregas,
  simulationActive,
  startSimulation,
  stopSimulation
} = usePackageSimulation()

// Iniciar simula√ß√£o
await startSimulation()
// entregas = [{lat: -23.08, lon: -46.01, razcli: "Cliente A", ...}, ...]

// Parar simula√ß√£o
stopSimulation()
```

### Tabelas Progress

#### PUB.semPararRot (Rotas)
```sql
CREATE TABLE PUB.semPararRot (
  sPararRotID INTEGER PRIMARY KEY,
  desSPararRot VARCHAR(60),     -- Nome da rota
  tempoViagem INTEGER,          -- Dias de viagem
  flgCD LOGICAL,                -- √â Centro de Distribui√ß√£o?
  flgRetorno LOGICAL,           -- Tem retorno?
  datAtu DATE,                  -- Data √∫ltima atualiza√ß√£o
  resAtu VARCHAR(15)            -- Respons√°vel atualiza√ß√£o
)
```

#### PUB.semPararRotMu (Munic√≠pios da Rota)
```sql
CREATE TABLE PUB.semPararRotMu (
  sPararRotID INTEGER,          -- FK para semPararRot
  sPararMuSeq INTEGER,          -- Sequ√™ncia do munic√≠pio (1, 2, 3...)
  codMun INTEGER,               -- C√≥digo do munic√≠pio
  codEst INTEGER,               -- C√≥digo do estado
  desMun VARCHAR(60),           -- Nome do munic√≠pio
  desEst VARCHAR(60),           -- Nome do estado
  cdibge INTEGER                -- C√≥digo IBGE (para geocoding)
)
```

### Fluxo de Simula√ß√£o

```
1. Usu√°rio seleciona pacote no autocomplete
   ‚îî‚îÄ‚ñ∂ POST /api/pacotes/itinerario {codPac: 3043368}

2. Backend retorna pedidos com GPS
   ‚îî‚îÄ‚ñ∂ {pedidos: [{gps_lat: "230876543", gps_lon: "460123456", ...}]}

3. Composable processa coordenadas
   ‚îî‚îÄ‚ñ∂ processGpsCoordinate("230876543") ‚Üí -23.0876543

4. Entregas filtradas (apenas com GPS v√°lido)
   ‚îî‚îÄ‚ñ∂ entregas: [{lat: -23.08, lon: -46.01, ...}]

5. Mapa atualizado com marcadores combinados
   ‚îî‚îÄ‚ñ∂ Azul: Munic√≠pios da rota SemParar
   ‚îî‚îÄ‚ñ∂ Verde: Primeira entrega
   ‚îî‚îÄ‚ñ∂ Laranja: Entregas intermedi√°rias
   ‚îî‚îÄ‚ñ∂ Vermelho: √öltima entrega

6. OSRM calcula rota combinada
   ‚îî‚îÄ‚ñ∂ waypoints: [rota1, rota2, ..., entrega1, entrega2, ...]
   ‚îî‚îÄ‚ñ∂ Polyline desenhada em rosa (#E91E63)
```

### Problemas Conhecidos e Solu√ß√µes

#### ‚ö†Ô∏è CR√çTICO: `updateSemPararRotaMunicipios()` Pode Perder Dados

**Problema:**
```php
// Progress JDBC N√ÉO suporta transa√ß√µes
DELETE FROM PUB.semPararRotMu WHERE sPararRotID = 204;  // ‚úÖ OK
// Se falhar aqui, munic√≠pios s√£o perdidos!
INSERT INTO PUB.semPararRotMu VALUES (...);  // ‚ùå Falha
```

**Mitiga√ß√£o Atual:**
- Valida√ß√£o pr√©via de dados
- Logging detalhado

**Solu√ß√£o Futura:**
- Strategy pattern (UPDATE/INSERT/DELETE granular)
- Valida√ß√£o completa antes de DELETE

#### ‚ö†Ô∏è OSRM P√∫blico Pode Falhar

**Problema:** Servidor p√∫blico pode ter downtime

**Mitiga√ß√£o:**
```typescript
.on('routingerror', (e) => {
  // Fallback: desenhar linha reta tracejada
  L.polyline(waypoints, {
    dashArray: '10, 10',
    opacity: 0.5
  }).addTo(map)
})
```

**Solu√ß√£o Futura:**
- Hospedar OSRM pr√≥prio via Docker
- Cache de rotas no banco

### URLs Importantes

- **Listagem:** http://localhost:8002/rotas-semparar
- **Mapa (Rota 204):** http://localhost:8002/rotas-semparar/mapa/204
- **Teste Pacote:** http://localhost:8002/test-leaflet-pacote

### Documenta√ß√£o Adicional

- **An√°lise Completa:** `ANALISE_ROTAS_SEMPARAR.md` (arquitetura, problemas, melhorias)
- **Sistema de Debug:** `DEBUG_MAPA_ROTAS.md` (como usar debug panel)

---

## Important Notes

- **Repository:** https://github.com/Psykhepathos/ndd-vuexy.git
- **Old systems (deprecated):** ndd-laravel, ndd-flutter repos
- **Key features:**
  - Dashboard NDD: http://localhost:8002/ndd-dashboard
  - Transportes: http://localhost:8002/transportes (transporter management)
  - Pacotes: http://localhost:8002/pacotes (package tracking)
  - Vale Ped√°gio: http://localhost:8002/vale-pedagio (toll pass calculator)
  - Rotas Padr√£o: http://localhost:8002/rotas-padrao (CRUD + interactive map with Leaflet/OSM)
  - Compra Viagem: http://localhost:8002/compra-viagem (SemParar trip purchase - in development)
- **Progress JDBC:** Located in `c:/Progress/OpenEdge/java/openedge.jar`
- **Java Connector:** Auto-compiled on first use in `storage/app/java/`
- **Pagination:** Progress lacks OFFSET - use subquery pattern in ProgressService
- **Always test functionality before committing**
- **Use Progress API endpoints for schema exploration, not tinker**

## Google Maps Integration

**Cache Strategy:**
- **Geocoding cache**: SQLite table `municipio_coordenadas` (persistent, no expiration)
- **Routing cache**: SQLite table `route_segments` (30 days TTL, ~100m tolerance)
- **Rate limiting**: 200ms delay between new Google API requests
- **Cache hit rate**: 80%+ after first visualization of routes

**Services:**
- `GeocodingService` - Converts IBGE codes ‚Üí lat/lon coordinates
- `RoutingService` - Calculates real road routes between points
- Both services use local cache to minimize API calls

**Quota monitoring:**
- Monitor usage: `GET /api/google-maps/quota`
- Reset counters: `POST /api/google-maps/reset-counters`

## Debugging Tips

**Progress connection issues:**
```bash
# Test connection
curl http://localhost:8002/api/progress/test-connection

# Check Java is installed
java -version

# Check Progress driver exists
dir "c:\Progress\OpenEdge\java\openedge.jar"

# View Laravel logs
php artisan pail
```

**Frontend issues:**
```bash
# Check TypeScript errors
pnpm run typecheck

# Check for linting issues
pnpm run lint

# Clear Vite cache
rm -rf node_modules/.vite && pnpm run dev
```

**Database queries:**
```bash
# Test custom SQL via API
curl -X POST http://localhost:8002/api/progress/query \
  -H "Content-Type: application/json" \
  -d '{"sql":"SELECT TOP 5 * FROM PUB.transporte"}'
```
